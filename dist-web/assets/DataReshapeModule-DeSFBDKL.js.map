{"version":3,"file":"DataReshapeModule-DeSFBDKL.js","sources":["../../src/pipeline/vizSeed/DataReshapeModule.ts"],"sourcesContent":["/**\n * 数据重塑模块 - 使用Pipeline子模块实现维度重塑\n * 基于fieldMap和图表要求，在pipeline中修改数据结构\n */\n\nimport { PipelineStep, PipelineContext, FieldSelection } from '../PipelineCore';\nimport { CHART_DATA_REQUIREMENTS } from '../../types/charts';\nimport { elevateStep, reduceStep } from './utils/ElevateAndReduce';\nimport { copyDimensionStep } from './utils/DimensionAndMeasureCopy';\n\n\n\n// 获取字段选择的辅助函数（仅本模块使用）\nconst getFieldSelection = (context: PipelineContext): FieldSelection => {\n  return context.fieldSelection;\n};\n\n// elevateStep 和 reduceStep 已从 './utils/ElevateAndReduce' 导入\n\n/**\n * 数据重塑Pipeline步骤 - 使用子模块实现智能重塑\n */\nexport const dataReshapeStep: PipelineStep = (vizSeed: any, context: PipelineContext) => {\n  const { data, chartType, fieldSelection} = context;\n  \n  if (!data || !chartType) {\n    return vizSeed;\n  }\n\n  \n  // 获取图表要求\n  const requirement = CHART_DATA_REQUIREMENTS[chartType as keyof typeof CHART_DATA_REQUIREMENTS];\n  \n  if (!requirement) {\n    return {\n      ...vizSeed,\n      data: context.data,\n      reshapeInfo: {\n        reshapeType: 'none',\n        reason: '未找到图表类型的数据要求'\n      }\n    };\n  }\n\n  let currentDims = fieldSelection.dimensions.length;\n  let currentMeas = fieldSelection.measures.length;\n  const targetDims = requirement.idealDimensions;\n  const targetMeas = requirement.idealMeasures;\n  \n  // 如果当前结构已经符合要求\n  if (currentDims === targetDims && currentMeas === targetMeas) {\n    return {\n      ...vizSeed,\n      data: context.data,\n      reshapeInfo: {\n        reshapeType: 'none'\n      }\n    };\n  }\n\n  const operations: string[] = [];\n\n  // 步骤1: 如果维度过多，使用降维子模块\n  if (currentDims > targetDims) {\n    let currentFieldSelection = getFieldSelection(context);\n    \n    // 多次降维直到达到目标维度数\n    while (currentFieldSelection.dimensions.length > targetDims) {\n      const beforeLength = currentFieldSelection.dimensions.length;\n      vizSeed = reduceStep(vizSeed, context);\n      \n      // 检查是否实际进行了降维\n      const afterFieldSelection = getFieldSelection(context);\n      if (afterFieldSelection.dimensions.length >= beforeLength) {\n        break; // 防止无限循环\n      }\n      \n      currentFieldSelection = afterFieldSelection;\n      operations.push('reduce');\n    }\n  }\n\n  // 步骤2: 如果指标过多，使用升维子模块\n  const finalFieldSelection = getFieldSelection(context);\n  if (finalFieldSelection.measures.length > targetMeas) {\n    vizSeed = elevateStep(vizSeed, context);\n    operations.push('elevate');\n  }\n\n  // 设置重塑信息\n  const finalReshapeType = operations.length === 1 ? \n    (operations[0] as 'elevate' | 'reduce') : \n    (operations.length > 1 ? 'composite' : 'none');\n\n  return {\n    ...vizSeed,\n    data: context.data,\n    reshapeInfo: {\n      strategy: `${currentDims}维度${currentMeas}指标 → ${targetDims}维度${targetMeas}指标`,\n      steps: operations,\n      reshapeType: finalReshapeType\n    }\n  };\n};\n\n"],"names":["getFieldSelection","context","dataReshapeStep","vizSeed","data","chartType","fieldSelection","requirement","CHART_DATA_REQUIREMENTS","__spreadProps","__spreadValues","currentDims","currentMeas","targetDims","targetMeas","operations","currentFieldSelection","beforeLength","reduceStep","afterFieldSelection","elevateStep","finalReshapeType"],"mappings":"4hBAaA,MAAMA,EAAqBC,GAClBA,EAAQ,eAQJC,EAAgC,CAACC,EAAcF,IAA6B,CACvF,KAAM,CAAE,KAAAG,EAAM,UAAAC,EAAW,eAAAC,CAAA,EAAkBL,EAE3C,GAAI,CAACG,GAAQ,CAACC,EACZ,OAAOF,EAKT,MAAMI,EAAcC,EAAwBH,CAAiD,EAE7F,GAAI,CAACE,EACH,OAAOE,EAAAC,EAAA,GACFP,GADE,CAEL,KAAMF,EAAQ,KACd,YAAa,CACX,YAAa,OACb,OAAQ,cAAA,CACV,GAIJ,IAAIU,EAAcL,EAAe,WAAW,OACxCM,EAAcN,EAAe,SAAS,OAC1C,MAAMO,EAAaN,EAAY,gBACzBO,EAAaP,EAAY,cAG/B,GAAII,IAAgBE,GAAcD,IAAgBE,EAChD,OAAOL,EAAAC,EAAA,GACFP,GADE,CAEL,KAAMF,EAAQ,KACd,YAAa,CACX,YAAa,MAAA,CACf,GAIJ,MAAMc,EAAuB,CAAA,EAG7B,GAAIJ,EAAcE,EAAY,CAC5B,IAAIG,EAAwBhB,EAAkBC,CAAO,EAGrD,KAAOe,EAAsB,WAAW,OAASH,GAAY,CAC3D,MAAMI,EAAeD,EAAsB,WAAW,OACtDb,EAAUe,EAAWf,EAASF,CAAO,EAGrC,MAAMkB,EAAsBnB,EAAkBC,CAAO,EACrD,GAAIkB,EAAoB,WAAW,QAAUF,EAC3C,MAGFD,EAAwBG,EACxBJ,EAAW,KAAK,QAAQ,CAAA,CAC1B,CAI0Bf,EAAkBC,CAAO,EAC7B,SAAS,OAASa,IACxCX,EAAUiB,EAAYjB,EAASF,CAAO,EACtCc,EAAW,KAAK,SAAS,GAI3B,MAAMM,EAAmBN,EAAW,SAAW,EAC5CA,EAAW,CAAC,EACZA,EAAW,OAAS,EAAI,YAAc,OAEzC,OAAON,EAAAC,EAAA,GACFP,GADE,CAEL,KAAMF,EAAQ,KACd,YAAa,CACX,SAAU,GAAGU,CAAW,KAAKC,CAAW,QAAQC,CAAU,KAAKC,CAAU,KACzE,MAAOC,EACP,YAAaM,CAAA,CACf,EAEJ"}